{% extends 'service_app/base.html' %}
{% block title %}Track Service - SMART SERVICE{% endblock %}
{% block extra_css %}
<style>
.track-wrap { max-width:800px;margin:0 auto;padding:40px 20px; }
.search-box { background:#fff;border-radius:16px;padding:32px;box-shadow:0 4px 20px rgba(0,0,0,0.08);margin-bottom:32px;text-align:center; }
.search-box h2 { font-family:'Orbitron',monospace;color:var(--secondary);font-size:24px;margin-bottom:8px; }
.search-row { display:flex;gap:12px;margin-top:20px;flex-wrap:wrap; }
.timeline { position:relative;padding:20px 0; }
.timeline::before { content:'';position:absolute;left:28px;top:0;bottom:0;width:3px;background:#e0e0e0; }
.step { display:flex;gap:20px;margin-bottom:28px;position:relative; }
.step-icon { width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;z-index:1;border:3px solid; }
.step-done .step-icon { background:var(--success);border-color:var(--success);color:#fff; }
.step-current .step-icon { background:var(--primary);border-color:var(--primary);color:#fff;animation:pulse 2s infinite; }
.step-pending .step-icon { background:#f5f5f5;border-color:#e0e0e0;color:#ccc; }
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(255,107,0,0.4);}50%{box-shadow:0 0 0 12px rgba(255,107,0,0);}}
.step-content { padding-top:12px; }
.step-content .stitle { font-weight:700;font-size:15px; }
.step-done .step-content .stitle { color:var(--success); }
.step-current .step-content .stitle { color:var(--primary); }
.step-pending .step-content .stitle { color:#ccc; }
.step-content .sdesc { font-size:13px;color:#999;margin-top:2px; }
.service-info-grid { display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px; }
@media(max-width:500px){.service-info-grid{grid-template-columns:1fr;}}
.info-box { background:#fff;border-radius:12px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,0.06); }
.info-box h3 { font-size:12px;text-transform:uppercase;letter-spacing:1px;color:var(--primary);font-weight:700;margin-bottom:14px; }
.irow { display:flex;justify-content:space-between;padding:6px 0;font-size:13px;border-bottom:1px solid #f5f5f5; }
.irow:last-child{border-bottom:none;}
</style>
{% endblock %}
{% block content %}
<div class="track-wrap">
    <div class="search-box">
        <h2><i class="fas fa-satellite-dish" style="color:var(--primary)"></i> Track Your Service</h2>
        <p style="color:#999;font-size:14px;">Enter your Tracking ID received via SMS or from the service advisor</p>
        <form method="GET" action="{% url 'track_service' %}">
            <div class="search-row">
                <input type="text" name="tracking_id" value="{{ tracking_id }}" placeholder="e.g. SS12345678" style="text-transform:uppercase;flex:1;" required>
                <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> Track</button>
            </div>
        </form>
    </div>

    {% if error %}
    <div class="alert alert-error"><i class="fas fa-exclamation-triangle"></i> {{ error }}</div>
    {% endif %}

    {% if service %}
    <div style="margin-bottom:20px;">
        <span class="badge badge-{{ service.status|lower }}" style="font-size:14px;padding:8px 20px;">{{ service.get_status_display }}</span>
        <span style="font-size:13px;color:#aaa;margin-left:12px;">Tracking ID: <strong style="color:var(--primary)">{{ service.tracking_id }}</strong></span>
    </div>

    <div class="service-info-grid">
        <div class="info-box">
            <h3><i class="fas fa-user"></i> Customer</h3>
            <div class="irow"><span style="color:#999">Name</span><span>{{ service.customer.name }}</span></div>
            <div class="irow"><span style="color:#999">Mobile</span><span>{{ service.customer.mobile }}</span></div>
        </div>
        <div class="info-box">
            <h3><i class="fas fa-car"></i> Vehicle</h3>
            <div class="irow"><span style="color:#999">Number</span><span>{{ service.vehicle.vehicle_number }}</span></div>
            <div class="irow"><span style="color:#999">Brand</span><span>{{ service.vehicle.brand }} {{ service.vehicle.model }}</span></div>
            <div class="irow"><span style="color:#999">Service</span><span>{{ service.get_service_type_display }}</span></div>
        </div>
    </div>

    <!-- Timeline -->
    <div class="info-box" style="margin-bottom:24px;">
        <h3><i class="fas fa-route"></i> Service Progress</h3>
        <div class="timeline" style="margin-top:20px;">
            {% with status=service.status %}
            <div class="step {% if status in 'OTP_VERIFIED ACCEPTED IN_PROGRESS COMPLETED DELIVERED' %}step-done{% elif status == 'PENDING' %}step-current{% else %}step-pending{% endif %}">
                <div class="step-icon">{% if status != 'PENDING' %}‚úì{% else %}‚è≥{% endif %}</div>
                <div class="step-content">
                    <div class="stitle">Service Registered</div>
                    <div class="sdesc">{{ service.created_at|date:"d M Y, h:i A" }}</div>
                </div>
            </div>
            <div class="step {% if status in 'ACCEPTED IN_PROGRESS COMPLETED DELIVERED' %}step-done{% elif status == 'OTP_VERIFIED' %}step-current{% else %}step-pending{% endif %}">
                <div class="step-icon">{% if status in 'ACCEPTED IN_PROGRESS COMPLETED DELIVERED' %}‚úì{% elif status == 'OTP_VERIFIED' %}üîê{% else %}üîê{% endif %}</div>
                <div class="step-content">
                    <div class="stitle">OTP Verified & Accepted</div>
                    <div class="sdesc">Customer confirmed the service request</div>
                </div>
            </div>
            <div class="step {% if status in 'COMPLETED DELIVERED' %}step-done{% elif status == 'IN_PROGRESS' %}step-current{% else %}step-pending{% endif %}">
                <div class="step-icon">{% if status in 'COMPLETED DELIVERED' %}‚úì{% elif status == 'IN_PROGRESS' %}üîß{% else %}üîß{% endif %}</div>
                <div class="step-content">
                    <div class="stitle">Work In Progress</div>
                    <div class="sdesc">Our mechanics are working on your vehicle</div>
                </div>
            </div>
            <div class="step {% if status == 'DELIVERED' %}step-done{% elif status == 'COMPLETED' %}step-current{% else %}step-pending{% endif %}">
                <div class="step-icon">{% if status == 'DELIVERED' %}‚úì{% elif status == 'COMPLETED' %}üéâ{% else %}‚úÖ{% endif %}</div>
                <div class="step-content">
                    <div class="stitle">Service Completed</div>
                    <div class="sdesc">{% if service.completed_at %}{{ service.completed_at|date:"d M Y, h:i A" }}{% else %}Awaiting completion{% endif %}</div>
                </div>
            </div>
            <div class="step {% if status == 'DELIVERED' %}step-done{% else %}step-pending{% endif %}">
                <div class="step-icon">{% if status == 'DELIVERED' %}‚úì{% else %}üöó{% endif %}</div>
                <div class="step-content">
                    <div class="stitle">Vehicle Delivered</div>
                    <div class="sdesc">Payment completed and vehicle handed over</div>
                </div>
            </div>
            {% endwith %}
        </div>
    </div>

    {% if service.assignments.all %}
    <div class="info-box">
        <h3><i class="fas fa-hard-hat"></i> Assigned Workers</h3>
        {% for a in service.assignments.all %}
        <div class="irow">
            <span>{{ a.worker.name }} <small style="color:#aaa">({{ a.worker.specialization }})</small></span>
            <span>{{ a.task_description|truncatechars:40 }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endif %}
</div>
{% endblock %}
